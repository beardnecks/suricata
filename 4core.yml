version: 0.2

env:
  variables:
    BUILD_CORES: "4"
    LIBHTP_BRANCH: "0.5.x"
    CFLAGS: "-Wall -Wextra -Werror -Wno-unused-parameter -Wno-unused-function"
    EXTRA_CFLAGS: ""
    ARGS: "--enable-rust-strict"

phases:
  install:
    - yum -y install dnf-plugins-core
    - yum config-manager --set-enabled PowerTools
    - |
      yum -y install \
            autoconf \
            automake \
            clang \
            diffutils \
            file-devel \
            gcc \
            gcc-c++ \
            gem \
            git \
            jansson-devel \
            jq \
            libcap-ng-devel \
            libevent-devel \
            libmaxminddb-devel \
            libnet-devel \
            libnetfilter_queue-devel \
            libnfnetlink-devel \
            libpcap-devel \
            libtool \
            libtool \
            libyaml-devel \
            lua-devel \
            lz4-devel \
            make \
            nss-devel \
            pcre-devel \
            pkgconfig \
            python3-devel \
            python3-sphinx \
            python3-yaml \
            rpm-build \
            ruby \
            ruby-devel \
            ruby-irb \
            ruby-libs \
            rubygems \
            rust-toolset \
            sudo \
            which \
            zlib-devel \
    - gem install fpm
    - curl https://sh.rustup.rs -sSf | sh -s -- --profile minimal --default-toolchain stable --component clippy --component rustfmt -y
    - export PATH="/root/.cargo/bin:${PATH}"
    - cargo install --force cbindgen
    - alternatives --set python /usr/bin/python3
  pre_build:
    commands:
      - export CFLAGS="${CFLAGS} ${EXTRA_CFLAGS}" && export BUILD_CORES=$(nproc)
      - git clone --depth 1 https://github.com/OISF/libhtp -b ${LIBHTP_BRANCH}
      - |
          cd suricata-update
          curl -L \
              https://github.com/OISF/suricata-update/archive/master.tar.gz | \
              tar zxvf - --strip-components=1
      - cd ..
      - |
        ./autogen.sh
        ./configure --enable-unittests \
              --enable-debug \
              --enable-lua \
              --enable-geoip \
              --enable-profiling \
              --enable-profiling-locks \
              ${ARGS}
  build:
    commands:
      - make -j${BUILD_CORES}
      - make -j${BUILD_CORES} check
